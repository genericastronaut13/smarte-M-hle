#include <WiFi.h>
#include <WebServer.h>
#include <HTTPClient.h>
#include <ArduinoJson.h>
#include <Stepper.h>

// =====================
// WLAN VERBINDUNG
// =====================
const char* ssid = "Kaffeemuehle";
const char* password = "12345678";

// =====================
// STEPPER MOTOR FÃœR MAHLGRAD
// =====================
// Anpassen an Ihren Stepper-Motor
const int stepsPerRevolution = 200;  // Schritte pro Umdrehung
Stepper stepper(stepsPerRevolution, 12, 14, 27, 26); // GPIO Pins

// =====================
// VARIABLEN
// =====================
int currentGrindLevel = 5;  // 1-10
int targetGrindLevel = 5;
bool isMoving = false;
String lastAction = "System gestartet";

// =====================
// WEB SERVER
// =====================
WebServer server(80);

// =====================
// MAHLGRAD POSITIONEN (Kalibrieren Sie diese Werte!)
// =====================
int grindPositions[11] = {
  0,      // 0 - nicht verwendet
  0,      // 1 - feinster Mahlgrad (Espresso)
  200,    // 2
  400,    // 3
  600,    // 4
  800,    // 5 - Standard
  1000,   // 6
  1200,   // 7
  1400,   // 8
  1600,   // 9
  1800    // 10 - grÃ¶bster Mahlgrad (French Press)
};

// =====================
// FUNKTIONEN
// =====================

void moveToGrindLevel(int level) {
  if (level < 1 || level > 10) {
    Serial.println("âš ï¸ UngÃ¼ltiger Mahlgrad (1-10)");
    return;
  }
  
  if (level == currentGrindLevel) {
    Serial.println("âœ“ Bereits auf Mahlgrad " + String(level));
    return;
  }
  
  isMoving = true;
  targetGrindLevel = level;
  
  int targetSteps = grindPositions[level];
  int currentSteps = grindPositions[currentGrindLevel];
  int stepsToMove = targetSteps - currentSteps;
  
  Serial.println("\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  Serial.println("   ğŸ”§ MAHLGRAD VERSTELLUNG");
  Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  Serial.println("Von: " + String(currentGrindLevel) + " (" + String(currentSteps) + " Schritte)");
  Serial.println("Nach: " + String(level) + " (" + String(targetSteps) + " Schritte)");
  Serial.println("Differenz: " + String(stepsToMove) + " Schritte");
  
  // Motor bewegen
  stepper.step(stepsToMove);
  
  currentGrindLevel = level;
  isMoving = false;
  
  lastAction = "Mahlgrad auf " + String(level) + " gestellt";
  
  Serial.println("âœ… Mahlgrad " + String(level) + " eingestellt");
  Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
}

// =====================
// KOMMUNIKATION MIT WEBSERVER
// =====================

void requestGrindLevelFromServer() {
  HTTPClient http;
  String url = "http://192.168.4.1/api/currentRecipe";
  
  http.begin(url);
  http.setTimeout(3000);
  
  int httpCode = http.GET();
  
  if (httpCode == 200) {
    String response = http.getString();
    
    // JSON parsen
    StaticJsonDocument<256> doc;
    DeserializationError error = deserializeJson(doc, response);
    
    if (!error) {
      int requestedLevel = doc["grindLevel"];
      if (requestedLevel >= 1 && requestedLevel <= 10) {
        moveToGrindLevel(requestedLevel);
      }
    }
  } else {
    Serial.println("Fehler beim Abrufen des Mahlgrads vom Server");
  }
  
  http.end();
}

void sendStatusToServer() {
  HTTPClient http;
  String url = "http://192.168.4.1/api/grinderStatus";
  
  http.begin(url);
  http.setTimeout(2000);
  
  StaticJsonDocument<256> doc;
  doc["grindLevel"] = currentGrindLevel;
  doc["isMoving"] = isMoving;
  doc["device"] = "Mahlgrad-Steuerung";
  
  String jsonString;
  serializeJson(doc, jsonString);
  
  http.addHeader("Content-Type", "application/json");
  http.POST(jsonString);
  http.end();
}

// =====================
// API ENDPOINTS (fÃ¼r direkte Steuerung)
// =====================

void handleSetGrindLevel() {
  if (server.hasArg("level")) {
    int level = server.arg("level").toInt();
    
    if (level >= 1 && level <= 10) {
      moveToGrindLevel(level);
      server.send(200, "application/json", "{\"success\":true,\"message\":\"Mahlgrad auf " + String(level) + " gestellt\",\"currentLevel\":" + String(currentGrindLevel) + "}");
    } else {
      server.send(400, "application/json", "{\"success\":false,\"message\":\"Mahlgrad muss 1-10 sein\"}");
    }
  } else {
    server.send(400, "application/json", "{\"success\":false,\"message\":\"Level nicht angegeben\"}");
  }
}

void handleGetStatus() {
  StaticJsonDocument<256> doc;
  doc["currentLevel"] = currentGrindLevel;
  doc["targetLevel"] = targetGrindLevel;
  doc["isMoving"] = isMoving;
  doc["lastAction"] = lastAction;
  
  String response;
  serializeJson(doc, response);
  server.send(200, "application/json", response);
}

void handleCalibrate() {
  // Kalibrierungsroutine (zum Einstellen der Positionen)
  if (server.hasArg("level") && server.hasArg("steps")) {
    int level = server.arg("level").toInt();
    int steps = server.arg("steps").toInt();
    
    if (level >= 1 && level <= 10) {
      grindPositions[level] = steps;
      server.send(200, "application/json", "{\"success\":true,\"message\":\"Position gespeichert\",\"level\":" + String(level) + ",\"steps\":" + String(steps) + "}");
    }
  } else {
    server.send(400, "application/json", "{\"success\":false,\"message\":\"Parameter fehlen\"}");
  }
}

void handleTestMove() {
  // Testet die Motorfunktion
  stepper.step(100);
  delay(500);
  stepper.step(-100);
  
  server.send(200, "application/json", "{\"success\":true,\"message\":\"Testbewegung durchgefÃ¼hrt\"}");
}

void handleNotFound() {
  server.send(404, "text/plain", "404: Not Found");
}

// =====================
// SETUP
// =====================

void setup() {
  Serial.begin(115200);
  delay(1000);
  
  Serial.println("\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  Serial.println("   MAHLGRAD-STEUERUNG - ESP32 #3");
  Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
  
  // Stepper Motor Setup
  stepper.setSpeed(60);  // RPM anpassen
  
  // WLAN konfigurieren
  WiFi.begin(ssid, password);
  
  // Statische IP setzen
  WiFi.config(IPAddress(192, 168, 4, 3),    // Feste IP fÃ¼r ESP32 #3
              IPAddress(192, 168, 4, 1),    // Gateway
              IPAddress(255, 255, 255, 0)); // Subnetz
  
  Serial.print("Verbinde mit WLAN ");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  
  Serial.println("\nâœ… WLAN verbunden");
  Serial.print("IP-Adresse: ");
  Serial.println(WiFi.localIP());
  
  // API Endpoints
  server.on("/setLevel", handleSetGrindLevel);
  server.on("/status", handleGetStatus);
  server.on("/calibrate", handleCalibrate);
  server.on("/test", handleTestMove);
  server.onNotFound(handleNotFound);
  
  server.begin();
  Serial.println("âœ… HTTP Server gestartet");
  
  // Initialisiere auf Standard-Mahlgrad
  delay(1000);
  moveToGrindLevel(5);
  
  Serial.println("\nVerfÃ¼gbare Befehle:");
  Serial.println("  /setLevel?level=3   - Stellt Mahlgrad 3 ein");
  Serial.println("  /status             - Status abfragen");
  Serial.println("  /calibrate?level=3&steps=400 - Kalibrierung");
  Serial.println("  /test               - Testbewegung");
}

// =====================
// LOOP
// =====================

void loop() {
  server.handleClient();
  
  // Alle 5 Sekunden Status an Server senden
  static unsigned long lastStatusUpdate = 0;
  if (millis() - lastStatusUpdate > 5000) {
    sendStatusToServer();
    lastStatusUpdate = millis();
  }
  
  // Alle 10 Sekunden auf neue Rezeptanfragen prÃ¼fen
  static unsigned long lastRecipeCheck = 0;
  if (millis() - lastRecipeCheck > 10000) {
    requestGrindLevelFromServer();
    lastRecipeCheck = millis();
  }
  
  delay(10);
}
